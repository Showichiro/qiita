---
title: Deno+Honoã§Webã‚µãƒ¼ãƒã‚’ç«‹ã¦ã‚‹ ~DenoKVã‚’æ·»ãˆã¦
tags:
  - Web
  - Deno
  - Hono
  - denokv
private: false
updated_at: '2023-11-02T12:31:06+09:00'
id: 6179ef4d9213af34f97d
organization_url_name: primebrains
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
å…ˆæ—¥ã€[Deno Fest](https://deno-fest-2023.deno.dev/)ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§èã„ã¦é¢ç™½ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¤šã‹ã£ãŸã®ã§ã€Denoã‚„Honoã€DenoKVãªã©ã‚’è§¦ã£ã¦ã¿ãŸããªã‚Šã¾ã—ãŸã€‚
ç°¡å˜ã«APIã‚„ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ä½œæˆãƒ»CIã‚’æ•´å‚™ã—ã¦æ‰€æ„Ÿã‚’æ›¸ãã¾ã™ã€‚Denoã‚‚Honoã‚‚åˆå¿ƒè€…ãªã®ã§èªè­˜ãŒèª¤ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ç‚¹ã”å®¹èµ¦ãã ã•ã„ã€‚

# ä½œã£ãŸã‚‚ã®
https://github.com/Showichiro/deno-kv-hono-postman-example

# Denoã«ã¤ã„ã¦

[å…¬å¼](https://docs.deno.com/runtime/manual)ã®èª¬æ˜ã«ã‚ˆã‚‹ã¨

> Deno (/ËˆdiËnoÊŠ/, pronounced dee-no) is a JavaScript, TypeScript, and WebAssembly runtime with secure defaults and a great developer experience. It's built on V8, Rust, and Tokio.

ã¤ã¾ã‚Šã€Javascriptãƒ»TypeScriptãƒ»WebAssemblyã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã™ã€‚

Deno Festã®è©±ã‚’èã„ã¦ã„ã‚‹é™ã‚Šã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ JavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯Nodeä»¥å¤–ã«ã‚‚ã€Deno/Bunãªã©ãŒè¦‡æ¨©ã‚’å·¡ã£ã¦äº‰ã£ã¦ã„ã‚‹æˆ¦å›½æ™‚ä»£ã®ã‚ˆã†ã§ã™ã€‚

## Denoã®ç‰¹å¾´

ãŸãã•ã‚“ã‚ã‚‹ã‚ˆã†ã§ã™ãŒã€[å…¬å¼](https://docs.deno.com/runtime/manual)ã®èª¬æ˜ã«ã‚ˆã‚‹ã¨

### TypeScriptã®çµ„ã¿è¾¼ã¿ã‚µãƒãƒ¼ãƒˆ
> Deno has built-in support for TypeScript as well. 

JavaScriptã¸ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãŒè¦ã‚Šã¾ã›ã‚“ã€‚

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

> A major feature of Deno is runtime security by default, meaning that you as the developer must explicitly allow your code to access potentially sensitive APIs like file system access, network connectivity, and access to environment variables.

ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦æ˜ç¤ºçš„ã«è¨±å¯ã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚

### URLã‹ã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿

> Deno supports loading and executing code from URLs, much as you would using a \<script\> tag in the browser. In Deno 1.x, the standard library and most third-party modules are distributed on HTTPS URLs.

ä»¥ä¸‹ã®ã‚ˆã†ã«URLæŒ‡å®šã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
import { assertEquals } from "https://deno.land/std@0.204.0/assert/mod.ts";
```

### çµ„ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼

> Deno has a built-in test runner that you can use for testing JavaScript or TypeScript code.

Nodeã«ãŠã‘ã‚‹jestãªã©ã®ã‚ˆã†ã«ã€åˆ¥ã§ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¦‹ç¹•ã†å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ãªã©ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€npmã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

# Honoã«ã¤ã„ã¦

[å…¬å¼](https://hono.dev/)ã«ã‚ˆã‚‹ã¨

> Hono - [ç‚] means flameğŸ”¥ in Japanese - is a small, simple, and ultrafast web framework for the Edges. It works on any JavaScript runtime: Cloudflare Workers, Fastly Compute@Edge, Deno, Bun, Vercel, Netlify, Lagon, AWS Lambda, Lambda@Edge, and Node.js.

ã©ã“ã§ã‚‚å‹•ãã‚ã£ã¡ã‚ƒæ—©ãã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã®ã“ã¨ã§ã™ã€‚ç‰¹ã«Webæ¨™æº–ã«å¾“ã£ã¦å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ã‚’å£²ã‚Šã«ã—ã¦ã„ã¾ã™(Webæ¨™æº–ã«å¾“ã£ã¦ã„ã‚‹å®Ÿè£…ã¦ã„ã‚‹ã‹ã‚‰ã©ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚‚å‹•ã)ã€‚

> Thanks to using only Web Standard APIs, we could make it work on Deno and Bun. "No Express for Bun?" we could answer, "No, but there is Hono" though Express works on Bun now.

ä½¿ã„æ–¹ã‚‚ç°¡å˜ã§expressãªã©ã‚’è§¦ã£ãŸã“ã¨ãŒã‚ã‚Œã°ã™ãã«ä½¿ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä»˜ãã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ä»Šå›ã¯çœã„ã¦ã„ã¾ã™ãŒã€JSXã‚µãƒãƒ¼ãƒˆã‚‚é€²ã‚“ã§ã„ã‚‹ã‚ˆã†ã§ã™(React**ã§ã¯ãªã„**ã®ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ã“ã¨ã¯ã‚„ã‚‰ãªã„)ã€‚

# Deno KVã«ã¤ã„ã¦

Denoçµ„ã¿è¾¼ã¿ã®ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ã‚¹ãƒˆã‚¢ã§ã™ã€‚ç¾åœ¨(2023/11/01æ™‚ç‚¹)Betaã§ã™ã€‚
APIã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚[ã‚­ãƒ¼ã«é…åˆ—ã§æ§˜ã€…ãªå€¤ã‚’æ¸¡ã›ã‚‹ã®ãŒç‰¹å¾´](https://docs.deno.com/kv/manual/key_space#key-examples)ã§ã€TanStack Queryã‚’å½·å½¿ã¨ã•ã›ã¾ã™ã€‚[ç°¡æ˜“ãªAPI](https://docs.deno.com/kv/manual/operations)ã§CRUDæ“ä½œãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

# ã„ã–å®Ÿè·µ

## Denoç’°å¢ƒæ§‹ç¯‰

[å…¬å¼](https://docs.deno.com/runtime/manual/)ã«å¾“ã„Denoãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚

```bash
curl -fsSL https://deno.land/x/install/install.sh | sh
```

ãƒ‘ã‚¹ã‚’é€šã™ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ãƒ‘ã‚¹ã‚’é€šã—ã¾ã™ã€‚

æœ€å¾Œã«ãƒ‘ã‚¹ãŒé€šã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
```bash
deno --version
```

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/619165/35ff2d99-b795-e2f4-d5aa-4ae5aceb8f11.png)

## Honoãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

Denoå‘ã‘ã®ç´¹ä»‹ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã®ã§[ãã¡ã‚‰](https://hono.dev/getting-started/deno)ã®é€šã‚Šé€²ã‚ã¾ã™ã€‚

```bash
deno run -A npm:create-hono my-app
```

```bash
cd my-app
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š

vscodeã‚’å‰æã«é€²ã‚ã¾ã™ã€‚

vscodeã®denoç”¨ã®æ‹¡å¼µæ©Ÿèƒ½(`denoland.vscode-deno`)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/619165/f16003b0-202c-c5ce-5d36-d36e492bdbf8.png)


`.vscode/settings.json`ã®è¨­å®šã‚’ã„ã˜ã‚Šã¾ã™ã€‚lint/formatã‚’è¨­å®šã—ã¾ã™ã€‚

```json:.vscode/settings.json
{
  "deno.enablePaths": [
    "./"
  ],
  "deno.enable": true,
  "editor.inlayHints.enabled": "off",
  "deno.lint": true,
  "editor.formatOnSave": true,
  "[typescript]": {
    "editor.defaultFormatter": "denoland.vscode-deno"
  }
}

```

`deno.json`ã‚’ä½œã‚Šã¾ã™ã€‚ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚

```jsonc:deno.json
{
  // package.jsonã®scriptsã¿ãŸã„ãªã‚‚ã®
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚„ãƒãƒƒãƒˆã¸ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã—ãŸã‚Šã€Deno KVã‚’ä½¿ã†ãŸã‚ã«--unstableãƒ•ãƒ©ã‚°ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚
  "tasks": {
    "dev": "deno run -A --unstable hello.ts",
    "test": "deno test -A --unstable"
  },
  // lockfileã‚’ä½œã‚‹ã‹ã©ã†ã‹
  "lock": false,
  // import specifiers
  "imports": {
    "hono": "https://deno.land/x/hono@v3.9.0/mod.ts",
    "ulid": "https://deno.land/x/ulid@v0.3.0/mod.ts",
    "assert": "https://deno.land/std@0.204.0/assert/mod.ts"
  }
}
```

## CRUDç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹

```ts
import { monotonicFactory } from "ulid";

const kv = await Deno.openKv("kv.sqlite");

type User = {
  name: string;
  age: number;
};

const findAllUsers = async () => {
  const entries = kv.list<User>({
    prefix: ["users", "id"],
  });
  let res: Array<User & { id: string }> = [];
  for await (const entry of entries) {
    res = [...res, { ...entry.value, id: entry.key[2] as string }];
  }
  return res;
};

const findUserById = async (id: string): Promise<User | null> => {
  const { value } = await kv.get<User>(["users", "id", id]);
  return value;
};
```

## serverå®Ÿè£…

honoã¯express likeã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts:hello.ts
import { Hono } from "hono";

const app = new Hono();

app.get(
  "/users",
  async (c) => {
    const res = await findAllUsers();
    return c.json(res);
  },
).get("/users/:id", async (c) => {
  const id = c.req.param("id");
  const value = await findUserById(id);
  return value ? c.json({ ...value, id }) : c.json(notFound, 404);
});

Deno.serve(app.fetch);

export default app;
```

### å®Ÿè¡Œ

```bash
deno task dev
```
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/619165/0eb561b7-88d9-bae1-ab95-f3252a73475b.png)



## ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

Denoã¯ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ãŒå†…è”µã•ã‚Œã¦ã„ã¾ã™ã€‚[å…¬å¼](https://docs.deno.com/runtime/manual/basics/testing/)ã®ä¾‹ã«å¾“ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚

```ts:hello.test.ts
import app from "./hello.ts";
import { assert, assertEquals, assertInstanceOf } from "assert";

type User = { id: string; name: string; age: number };

Deno.test("GET /users", async () => {
  const res = await app.request("/users", { method: "GET" });
  assertEquals(res.status, 200);
  const json = await res.json();
  assertInstanceOf(json, Array<User>);
});
```

### ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

```bash
deno task test
```

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/619165/f9f380a7-c231-80b0-b821-e3bb5f076eb0.png)


## CIæ•´å‚™ã™ã‚‹

ç‰¹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šå›ºæœ‰ã®è¨­å®šã¯ãªã„ã®ã§githubã«å‡ºã¦ããŸã‚‚ã®ã‚’ã»ã¼ãã®ã¾ã¾æ¡ç”¨ã€‚

```yaml:.github/workflows/deno.yml
# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow will install Deno then run `deno lint` and `deno test`.
# For more information see: https://github.com/denoland/setup-deno

name: Deno

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Setup repo
        uses: actions/checkout@v3

      - name: Setup Deno
        # uses: denoland/setup-deno@v1
        uses: denoland/setup-deno@61fe2df320078202e33d7d5ad347e7dcfa0e8f31  # v1.1.2
        with:
          deno-version: v1.x

      # Uncomment this step to verify the use of 'deno fmt' on each commit.
      # - name: Verify formatting
      #   run: deno fmt --check

      - name: Run linter
        run: deno lint

      - name: Run tests
        run: deno task test

```

# æ‰€æ„Ÿ

## Denoã¯ã”ã¡ã‚ƒã”ã¡ã‚ƒã—ã¦ãªãã¦ã„ã„

Nodeã‚’ç”¨ã„ãŸé–‹ç™ºã‚ã‚‹ã‚ã‚‹ã®å¤§é‡ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(package.json/eslint/prettier/jest.config...)ãŒãªãã€node_modulesãŒãªãJavaScriptã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã‚‚æ„è­˜ã—ãªã„ã®ã§ãƒªãƒã‚¸ãƒˆãƒªãŒã¨ã¦ã‚‚ã‚¹ãƒƒã‚­ãƒªã—ã¦ã„ã¦èªçŸ¥çš„ãªè² è·ãŒä½ã„ã‚ˆã†ã«æ„Ÿã˜ã¾ã—ãŸã€‚ç‰¹ã«åˆå¿ƒè€…ãŒå‚ç”»ã™ã‚‹æ¡ˆä»¶ãªã©ã§èªçŸ¥çš„ãªè² è·ãŒä½ã„ã®ã¯é‡è¦ãªæ°—ãŒã—ã¾ã™ã€‚ãŸã ã—ã€ã“ã®è¾ºã¯å®Ÿå‹™ã§åˆ©ç”¨ã™ã‚‹ã¨ä½•ã‹ã¨ãƒ„ãƒ¼ãƒ«ãŒå¢—ãˆã¦ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## Honoã¯ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªè¦ä»¶ã§ã‚ã‚Œã°ä½¿ã„å‹æ‰‹ãŒã‚ˆã•ãã†

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã®ãŠä½œæ³•ã‚„æ±ºã‚äº‹ãŒéå¸¸ã«å°‘ãªã„å°è±¡ã§ã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã†ã§ã™ã€‚ãã®ã†ãˆã§Webæ¨™æº–ã«å‰‡ã£ã¦ã„ã‚‹ãŸã‚æ±ç”¨æ€§ãŒé«˜ãã†ã¨ã„ã†æ„å‘³ã§å¥½å°è±¡ã‚’å—ã‘ã¦ã¾ã—ãŸï¼ˆãƒ†ã‚¹ãƒˆã‚’æ›¸ãéš›ã«ç›´æ„Ÿçš„ã«æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸï¼‰ã€‚ä¸€æ–¹ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã‚†ãˆã«ã€è¤‡é›‘ãªæ¥­å‹™è¦ä»¶ãªã©ãŒã‚ã‚‹ã‚¢ãƒ—ãƒªé–‹ç™ºã§ã¯ã€çµæ§‹å¤§å¤‰ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šãã†ãªå°è±¡ã‚’å—ã‘ã¾ã—ãŸï¼ˆãã†ã„ã†ã‚±ãƒ¼ã‚¹ã¯ãã‚‚ãã‚‚HonoãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¦ã„ãªã„ã¨æ€ã„ã¾ã™ã—ï¼‰ã€‚
